# /setup-rag - Set Up the RAG MCP Server

Set up the mathlib quality RAG server so Claude Code can search 4,600+ PR review examples for golfing and style suggestions.

## Usage

```
/setup-rag
```

No arguments needed. This command will guide you through setup.

## What This Does

The RAG (Retrieval Augmented Generation) server provides Claude Code with tools to search real mathlib PR review feedback:

- `search_golf_examples` - Find similar code patterns and how reviewers suggested improving them
- `search_by_pattern` - Find examples of specific transformations (grind, fun_prop, simpa, etc.)
- `search_by_topic` - Find examples related to mathematical topics
- `get_mathlib_quality_principles` - Get synthesized quality rules from PR reviews

## Setup Workflow

### Step 1: Locate the Plugin

Find the mathlib-quality plugin installation directory. The RAG index files should be at:
```
<plugin_dir>/data/pr_feedback/rag_index.json
<plugin_dir>/data/pr_feedback/rag_index_focused.json
```

To find the plugin directory, check:
1. The current working directory (if working inside the plugin repo)
2. `~/.claude/plugins/mathlib-quality/` (default plugin install location)
3. Any path the user specifies

Confirm the index files exist:
```bash
ls -lh <plugin_dir>/data/pr_feedback/rag_index.json
ls -lh <plugin_dir>/data/pr_feedback/rag_index_focused.json
```

If the files don't exist, tell the user to run the build script:
```bash
cd <plugin_dir> && python3 scripts/build_rag_index.py
```

### Step 2: Check Python Dependencies

The MCP server requires the `mcp` Python package:

```bash
python3 -c "import mcp" 2>/dev/null && echo "OK" || echo "MISSING"
```

If missing, ask the user for permission to install it:
```bash
pip install mcp
```

### Step 3: Configure MCP Server

Ask the user for permission, then add the `mathlib-rag` server to the **project-level** `.mcp.json` in their current working directory.

Read the existing `.mcp.json` if it exists (to preserve other servers), then add or update the `mathlib-rag` entry:

```json
{
  "mcpServers": {
    "mathlib-rag": {
      "command": "python3",
      "args": ["<plugin_dir>/mcp_server/mathlib_rag.py"]
    }
  }
}
```

**Important:** Use the absolute path to `mathlib_rag.py` so it works regardless of working directory.

If `.mcp.json` already exists with other servers, merge the new entry — don't overwrite existing servers.

### Step 4: Verify

Test that the server can load by running:
```bash
python3 -c "
import json, sys
sys.path.insert(0, '<plugin_dir>/mcp_server')
from mathlib_rag import load_index
idx, focused = load_index()
print(f'Loaded {len(idx[\"all_examples\"])} examples from main index')
if focused:
    total = sum(len(v) for v in focused['by_pattern'].values())
    print(f'Loaded {total} focused examples')
print('RAG server ready!')
"
```

### Step 5: Report

Tell the user:
1. The MCP server has been configured
2. They need to **restart Claude Code** (or reload MCP servers) for the new server to take effect
3. After restart, the RAG tools will be available automatically when working on Lean files
4. They can test with: `search_by_pattern(pattern="use_grind")`

## Troubleshooting

### "mcp package not found"
```bash
pip install mcp
# or
pip install mcp --user
```

### "Index files not found"
The index files should be included in the plugin repo. If missing:
```bash
cd <plugin_dir>
python3 scripts/build_rag_index.py
```
This requires the raw feedback data files (`data/pr_feedback/proof_golf_feedback.json`, etc.).

### "Server not appearing in Claude Code"
1. Check that `.mcp.json` is in the project root (where you run Claude Code from)
2. Restart Claude Code after adding the config
3. Verify the path in `.mcp.json` is absolute and correct

## Notes

- The RAG index files (~5MB total) are included in the plugin repository
- Raw feedback data files (~13MB) are gitignored and can be regenerated by re-scraping
- The MCP server runs as a subprocess managed by Claude Code — no separate process to manage
