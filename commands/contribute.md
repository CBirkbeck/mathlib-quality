---
name: contribute
description: Contribute local learnings back to the mathlib-quality repo via PR
---

# /contribute - Contribute Learnings Back

Review local learnings and create a PR to contribute them to the mathlib-quality repository, so all users benefit.

## Usage

```
/contribute
/contribute --dry-run   (preview without creating PR)
```

## Prerequisites

- `.mathlib-quality/learnings.jsonl` exists with at least one entry
- `gh` CLI is authenticated (for creating PRs)
- Network access to GitHub

## Workflow

### Step 1: Read Local Learnings

Read `.mathlib-quality/learnings.jsonl` and parse all entries.

If the file doesn't exist or is empty:
```
No learnings found in `.mathlib-quality/learnings.jsonl`.

Run some commands (/cleanup, /golf-proof, /teach) first to accumulate learnings,
then come back to contribute them.
```

### Step 2: Deduplicate

Remove duplicate entries:
- Same `before_code` AND `after_code` = duplicate (keep the more recent one)
- Same `description` with same `type` = likely duplicate
- Entries with `"accepted": false` are kept separately (valuable negative data)

### Step 3: Present Summary

Show the user what was found, grouped by type:

```
## Learnings Summary

Found N learnings in `.mathlib-quality/learnings.jsonl`:

### Golf Patterns (X entries)
1. [theorem_name] Inlined have + term mode: 3 lines → 1 line
2. [theorem_name] grind closed Finset.card goal
3. ...

### Style Corrections (Y entries)
1. Fixed by-placement pattern in 5 proofs
2. ...

### Mathlib Discoveries (Z entries)
1. Replaced custom `finite_of_discrete` with `IsCompact.finite`
2. ...

### User Teachings (W entries)
1. "Always try grind before omega for Fin goals"
2. ...

### Failed Patterns (V entries)
1. grind timed out on algebraic goals with ring structure
2. ...

---

Select which to contribute:
- [a] All accepted learnings (N entries) (Recommended)
- [s] Select individually
- [n] None (cancel)
```

### Step 4: User Selection

Let the user choose which learnings to include. By default, include all entries where `"accepted": true`. Entries with `"accepted": false` are included only if the user explicitly selects them (they're valuable as negative examples).

### Step 5: Sanitize for Privacy

Before contributing, remove or anonymize:
- Full file paths → keep only the filename (e.g., `MyProject/Foo.lean` → `Foo.lean`)
- Project names → use a generic identifier if the user prefers
- Any code that might contain proprietary content → flag and ask user

```
## Privacy Check

The following entries reference project-specific paths:
1. Entry abc123: file_path = "src/MyProject/CustomThing.lean"
2. Entry def456: before_code contains project-specific definition

Options:
- [a] Anonymize paths (keep filenames only) (Recommended)
- [k] Keep full paths
- [r] Review each entry
```

### Step 6: Create the Contribution

Generate a JSONL file with the selected, sanitized learnings.

**Determine project identifier:**
```bash
# Try to get project name from git remote
git remote get-url origin 2>/dev/null | sed 's/.*\///' | sed 's/\.git$//'
```

**File name format:** `data/community_learnings/<date>_<project-hash>.jsonl`
- `<date>`: YYYY-MM-DD
- `<project-hash>`: first 8 chars of SHA256 of project name (for privacy)

### Step 7: Create PR

Use `gh` CLI to fork (if needed) and create a PR:

```bash
# Clone or use existing fork
gh repo fork CBirkbeck/mathlib-quality --clone=false

# Create a branch
BRANCH="learnings/$(date +%Y%m%d)-$(head -c 8 /dev/urandom | xxd -p | head -c 8)"

# Add the learnings file
# Create PR
gh pr create \
  --repo CBirkbeck/mathlib-quality \
  --title "learnings: N patterns from [project-identifier]" \
  --body "$(cat <<'EOF'
## Community Learnings Contribution

### Summary
| Type | Count |
|------|-------|
| Golf patterns | X |
| Style corrections | Y |
| Mathlib discoveries | Z |
| User teachings | W |
| Failed patterns | V |

### Sample Entries
[Show 2-3 representative entries]

### Source
- Project: [anonymized identifier]
- Commands used: cleanup, golf-proof, teach, ...
- Date range: [first entry timestamp] to [last entry timestamp]

---
Generated by mathlib-quality `/contribute` command.
EOF
)"
```

### Step 8: Confirm

```
## Contribution Created

PR: https://github.com/CBirkbeck/mathlib-quality/pull/XX
- Title: "learnings: 12 patterns from lean-project-a1b2c3d4"
- Entries contributed: 12
- File: data/community_learnings/2026-02-28_a1b2c3d4.jsonl

The maintainers will review and integrate useful patterns into the
reference docs and RAG index.

Thank you for contributing!
```

## Dry Run Mode

With `--dry-run`, show everything except actually creating the PR:

```
## Contribution Preview (Dry Run)

Would create PR with:
- Title: "learnings: 12 patterns from lean-project-a1b2c3d4"
- File: data/community_learnings/2026-02-28_a1b2c3d4.jsonl
- Entries: 12 (8 golf, 2 style, 1 mathlib, 1 teaching)

Sample entries:
[Show 3 representative entries in full JSON]

Run `/contribute` (without --dry-run) to create the PR.
```

## Output Format

```
## Contribution Report

### Learnings Analyzed
- Total entries: 25
- After dedup: 20
- Accepted: 18
- Failed patterns: 2

### Selected for Contribution
- Golf patterns: 8
- Style corrections: 3
- Mathlib discoveries: 2
- User teachings: 3
- Failed patterns: 2
- **Total: 18 entries**

### PR Created
- URL: https://github.com/CBirkbeck/mathlib-quality/pull/XX
- Branch: learnings/20260228-a1b2c3d4
- File: data/community_learnings/2026-02-28_a1b2c3d4.jsonl

### What Happens Next
1. Maintainers review the contribution
2. Useful patterns get integrated into:
   - RAG index (searchable examples)
   - Reference docs (style/naming rules)
   - Example files (curated before/after)
3. All users benefit from the patterns you discovered
```

## Error Handling

### No learnings file
```
No learnings found. Run some mathlib-quality commands first to generate learnings.
```

### gh not authenticated
```
GitHub CLI not authenticated. Run `gh auth login` first.
```

### Network error
```
Could not reach GitHub. Learnings saved locally in:
  .mathlib-quality/contribution_draft_2026-02-28.jsonl

You can submit manually later or retry with `/contribute`.
```
